# 機能仕様書: プロジェクトルート自動検出機能

機能名: `1-project-root-detection`  
作成日: 2025-01-27  
モデル名: Claude Sonnet 4.5  
仕様書テンプレートバージョン: 1.0.1

## 概要
`noaqh-dev`コマンドがプロジェクトディレクトリ以外で実行されても正しく動作するように、実行ファイルの場所からプロジェクトルートを自動検出する機能を実装します。

## 要件 *(必須)*

### 機能実装前後の変更点
#### 機能実装前
- `noaqh-dev`コマンドは実行時のカレントディレクトリ（`process.cwd()`）を基準にテンプレートディレクトリやプロンプトディレクトリを参照していました
- プロジェクトディレクトリ以外で実行すると、`template/prompts`ディレクトリが見つからずエラーが発生していました
- エラーメッセージ: `Template directory not found: template/prompts`
- エラーメッセージ: `ENOENT: no such file or directory, open 'template/prompts/bug-check.md'`

#### 機能実装後
- `noaqh-dev`コマンドは実行されているモジュール（`src/cli.ts`）の場所から相対的にプロジェクトルートを特定します
- プロジェクトディレクトリ以外から実行しても、プロジェクトルートを基準に正しくテンプレートディレクトリやプロンプトディレクトリを参照できます
- プロジェクトルートが見つからない場合は、明確なエラーメッセージを表示して処理を終了します
- インストール先のディレクトリ（`~/.codex/prompts`、`~/.claude/commands`、`~/.roo/commands`）は既にホームディレクトリ基準で実装されているため変更不要です

### 機能要件

- FR-001: システムは実行されているモジュール（`src/cli.ts`）の場所から相対的にプロジェクトルートを特定できなければならない (detect-project-root)_1
- FR-002: システムはプロジェクトルートを基準にテンプレートディレクトリ（`template/prompts`）のパスを解決できなければならない (detect-project-root)_1
- FR-003: システムはプロジェクトルートを基準にプロンプトディレクトリ（`prompts`）のパスを解決できなければならない (detect-project-root)_1
- FR-004: システムはプロジェクトルートが見つからない場合、明確なエラーメッセージを表示して処理を終了しなければならない (detect-project-root)_1

### エンティティ構造

エンティティ構造の変更は不要です。既存のファイルを修正し、新しいユーティリティ関数を追加するのみです。

## 成功基準 *(必須)*

- プロジェクトディレクトリ以外（例: ホームディレクトリ）から`noaqh-dev install-all`を実行しても、正常にプロンプトが生成・インストールされること
- リポジトリのディレクトリがどこにあっても（例: `/opt/noaqh-dev`、`~/projects/dev_tool`など）、正常に動作すること
- プロジェクトルートが見つからない場合（モジュールが予期しない場所にある場合など）、明確なエラーメッセージが表示されること
- プロジェクトディレクトリ内から実行した場合も、従来通り正常に動作すること
- インストール先のディレクトリ（`~/.codex/prompts`など）はホームディレクトリ基準で正しく動作すること

### 型定義 *(新規型が必要な場合に含める)*

#### 共通型 (shared/types/types.ts)

新規型定義は不要です。エラークラスのみ追加します。

#### エラークラス (src/util/project-root.ts)

- `ProjectRootNotFoundError`: プロジェクトルートが見つからない場合にthrowされるエラー

### 実装手順

#### 実装セット (detect-project-root)_1: プロジェクトルート検出機能の実装

- 対象ファイル:
  - エントリーポイント:
    - 新規追加: `src/util/project-root.ts`
      - 関数: `getProjectRoot(): string`
      - 実装前状態: プロジェクトルート検出機能が存在しない
      - 実装後状態: 実行されているモジュール（`src/cli.ts`）の場所から相対的にプロジェクトルートを特定し、そのパスを返す。プロジェクトルートが見つからない場合はエラーをthrowする
      - 実装内容: `src/cli.ts`の`import.meta.url`を使用してモジュールのパスを取得し、そこから`../`でプロジェクトルートを計算する（`src/cli.ts`は`src/`ディレクトリにあるため、その親ディレクトリがプロジェクトルート）
      - 使用するPort: なし
  - 修正: `script/generate-prompt.ts`
    - 関数: `generatePrompts()`がプロジェクトルートを取得し、そこから相対的にテンプレートディレクトリとプロンプトディレクトリを解決するように変更
  - 修正: `src/features/prompt/command/install-prompts/handler.ts`
    - 関数: `installPrompts()`, `installClaudeCodePrompts()`, `installRooPrompts()`がプロジェクトルートを取得し、そこから相対的にプロンプトディレクトリを解決するように変更
- 対象テストファイル: 
  - `src/util/project-root.test.ts` (新規作成)
    - テスト項目:
      - プロジェクトディレクトリ内から実行した場合、プロジェクトルートが正しく取得できる
      - プロジェクトディレクトリ外から実行した場合、プロジェクトルートが正しく取得できる
      - 実行ファイルが予期しない場所にある場合、適切なエラーがthrowされる
- 実装内容: プロジェクトルート検出のユーティリティ関数を実装し、既存のコードで使用している相対パス解決をプロジェクトルート基準に変更する

- 手順:
  - [x] `src/util/`ディレクトリを作成
  - [x] `ProjectRootNotFoundError`エラークラスを定義(`src/util/project-root.ts`)
    - `PromptsSourceNotFoundError`や`GitRepositoryNotFoundError`と同じパターンで実装
    - エラーメッセージは明確で分かりやすいものにする
  - [x] `getProjectRoot()`関数を実装(`src/util/project-root.ts`)
    - `src/cli.ts`の`import.meta.url`を参照する方法を検討する（`src/cli.ts`から`import.meta.url`を取得するか、`src/util/project-root.ts`自身の`import.meta.url`から`src/cli.ts`の相対パスを計算する）
    - 推奨方法: `src/util/project-root.ts`の`import.meta.url`を使用し、このファイルは`src/util/`にあるため、`../../`でプロジェクトルートを計算する
    - `fileURLToPath`と`dirname`を使用してモジュールのディレクトリパスを取得
    - `src/util/project-root.ts`は`src/util/`ディレクトリにあるため、`../../`でプロジェクトルートに到達
    - プロジェクトルートに`package.json`が存在することを確認（検証用）
    - 存在しない場合は`ProjectRootNotFoundError`をthrow
  - [x] `getProjectRoot()`のテストを作成(`src/util/project-root.test.ts`)
    - プロジェクトディレクトリ内から実行した場合のテスト
    - プロジェクトディレクトリ外から実行した場合のテスト（モックを使用）
    - エラーケースのテスト
  - [x] `bun run test src/util/project-root.test.ts`を実行しテストが通ることを確認する。テストが通らない場合はエラー内容を確認し、エラー内容に沿って修正を行う
  - [x] `generatePrompts()`関数を修正(`script/generate-prompt.ts`)
    - `getProjectRoot()`を呼び出してプロジェクトルートを取得
    - `TEMPLATE_DIR`と`OUTPUT_DIR`をプロジェクトルート基準の絶対パスに変更
    - `TEMPLATE_DIR`と`OUTPUT_DIR`の定数定義を削除し、関数内で動的に生成
  - [x] `generatePrompts()`のテストを実行し、プロジェクトディレクトリ外からでも正常に動作することを確認
  - [x] `installPrompts()`, `installClaudeCodePrompts()`, `installRooPrompts()`関数を修正(`src/features/prompt/command/install-prompts/handler.ts`)
    - `DEFAULT_SOURCE_DIR`をプロジェクトルート基準の絶対パスに変更
    - `getProjectRoot()`を呼び出してプロジェクトルートを取得する処理を追加
    - `DEFAULT_SOURCE_DIR`の定数定義を関数内で動的に生成するように変更
  - [x] `installPrompts()`系のテストを実行し、プロジェクトディレクトリ外からでも正常に動作することを確認
  - [x] コードスタイルに沿っているか確認し、リファクタリングも合わせて行う
  - [x] リファクタリング後、再度すべてのテストを実行し、すべてのテストが通ることを確認
  - [x] 実際にプロジェクトディレクトリ外から`noaqh-dev install-all`を実行し、正常に動作することを確認

### 影響ページ

- `noaqh-dev`コマンドを使用するすべてのユーザーに影響があります
- プロジェクトディレクトリ外からコマンドを実行するユーザーにとって、動作が改善されます

### 確認すべき項目

#### ローカル確認できる項目

- **プロジェクトディレクトリ外からの実行**: 
  確認すべき理由: 本機能の主要な目的は、プロジェクトディレクトリ外からでもコマンドが正常に動作することを保証することです
  確認すべき内容: ホームディレクトリやその他の任意のディレクトリから`noaqh-dev install-all`を実行し、エラーなくプロンプトが生成・インストールされることを確認します
  確認方法: ターミナルで`cd ~`を実行してから`noaqh-dev install-all`を実行し、正常に完了することを確認します

- **プロジェクトディレクトリ内からの実行**: 
  確認すべき理由: 既存の動作が壊れていないことを確認するため
  確認すべき内容: プロジェクトディレクトリ内から`noaqh-dev install-all`を実行し、従来通り正常に動作することを確認します
  確認方法: プロジェクトディレクトリに移動してから`noaqh-dev install-all`を実行し、正常に完了することを確認します

- **エラーハンドリング**: 
  確認すべき理由: プロジェクトルートが見つからない場合のエラーメッセージが適切であることを確認するため
  確認すべき内容: モジュールが予期しない場所にある場合、明確で分かりやすいエラーメッセージが表示されることを確認します
  確認方法: テストコードでエラーケースを確認するか、プロジェクトを一時的に別の場所に移動してエラーメッセージを確認します

- **リポジトリの場所に依存しない動作**: 
  確認すべき理由: リポジトリがどこにあっても正常に動作することを保証するため
  確認すべき内容: リポジトリを任意の場所（例: `/opt/noaqh-dev`、`~/projects/dev_tool`など）に移動しても、正常に動作することを確認します
  確認方法: リポジトリを別の場所にコピーまたは移動し、そこから`noaqh-dev install-all`を実行して正常に動作することを確認します

#### デプロイ環境でのみ確認できる項目

デプロイ環境でのみ確認できる項目はありません。

