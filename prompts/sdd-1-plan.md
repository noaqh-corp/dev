仕様書駆動開発のフェーズ1としてユーザーから要求を受け取り、実装計画をユーザーと合意するために実装計画書テンプレートをもとに実装計画書を作成しマークダウンファイルに保存し、ユーザーと実装計画の合意をすることが最終目的です。この文章は実装の指針となりクオリティを高く保つために非常に重要な文章です。ルール、手順に慎重に従い、実装計画書を作成してください。

## ルール
- 必要最低限の実装になるように現状のソースコードを元に提案を行いなさい。
- テンプレート内のコメントは指示です。
- `{}`で囲まれた部分は置き換えるべきテキストです。
- 手順は必ず`update_plan`ツールを活用し、順に対応しなさい。
- アーキテクチャは(https://github.com/noaqh-corp/dev/blob/main/docs/architecture.md)から取得しなさい。
- 実装計画書テンプレートは(https://raw.githubusercontent.com/noaqh-corp/dev/refs/heads/main/docs/plan_template.md)から取得しなさい。
- コードスタイルは(https://raw.githubusercontent.com/noaqh-corp/dev/refs/heads/main/prompts/code-style-review.md)から取得しなさい。
- 実装計画書テンプレートは(spec/{feature_number}-{feature_name}/plan.md)に保存しなさい。
- 実装計画書は手順の中で何度も更新されます。クオリティが下がる原因になるため無理にまとめて作業はしてはいけません。

## ディレクトリ構成
- spec/{feature_number}-{feature_name}/
    - plan.md # フェーズ1で作成する実装計画書
    - implementation_report.md # フェーズ2で作成する実装結果レポート


## 手順
1. 実装計画書テンプレート、アーキテクチャを読み込み、読み込んだ情報を元にユーザーからの要求を分析しなさい。
2. 1で不明点、仕様が曖昧な点、不足している点があれば必ず要求分析質問テンプレートを使ってユーザーに確認してください。
3. 2でユーザーからの回答を受け取り、1に戻り不明点、仕様が曖昧な点、不足している点がなくなるまで繰り返しなさい。
4. 実装質問テンプレートを使ってユーザーに実装について質問しなさい。
5. 4でユーザーからの回答を受け取り、実装についての不明点、仕様が曖昧な点、不足している点がなくなるまで繰り返しなさい。
6. 集めた情報を元に実装計画書テンプレートに従い実装計画書を`spec/{feature_number}-{feature_name}/plan.md`に作成しなさい。
7. 実装計画書テンプレート、アーキテクチャを再度読み込み、抜け漏れがないかを注意深く確認しなさい。これらの文章には例示が多く含まれています。この例示は非常に重要なので尊重されていることを確認しなさい。
8. コードスタイルドキュメントを読み込み、文章内の各記述がコードスタイルに沿っているかを確認しなさい。
9. 実装計画書テンプレート、アーキテクチャ、コードスタイルドキュメントを再度読み込み、抜け漏れがないかを注意深く確認しなさい。これらの文章には例示が多く含まれています。この例示は非常に重要なので尊重されていることを確認しなさい。
10. 最後に実装計画書をユーザーに報告してください。もし、懸念点があれば各質問テンプレートを使ってユーザーに確認してください。


## 要求分析質問テンプレート
```
<!-- 
ユーザーの手間を最小限にしつつ、計画作成に必要な情報を収集するための質問テンプレートです。無駄な質問はせず、本質的に重要な質問のみ行いなさい。実装や非機能要件について質問せず、要求についてのみ最大5個程度の質問をしなさい。
-->

計画を作成するにあたって、以下の質問に回答してください。複数選択可能です。

## 要求分析

<!-- 
このセクションユーザーからの要求を整理します。要求について曖昧な点や不明瞭な点を質問し、明確にすることが目的です。
 -->


### {質問のタイトル}
{ユーザーへ確認すべき質問。基本的には技術的詳細ではなく、振る舞いについて質問するべきです。ex: "クーポンにはどのような機能が必要ですか？"}

s-1. [提案する内容タイトル ex: "有効期限を設定する"]: [提案する内容 ex: "有効期限を設定できるようにします。失効する日時は具体的な日時を入力できるようにします。"]
s-2. [提案する内容タイトル ex: "1人あたり利用回数を制限"]: [提案する内容 ex: "1人あたり利用回数を制限できるようにします。具体的な回数を入力できるようにします。"]
s-3. [提案する内容タイトル ex: "システム全体での利用回数を制限"]: [提案する内容 ex: "システム全体での利用回数を制限できるようにします。具体的な回数を入力できるようにします。"]
{...他にもあれば項目を追加してください。}

### {質問のタイトル}
{ユーザーへ確認すべき質問。基本的には技術的詳細ではなく、振る舞いについて質問するべきです。ex: "クーポンの割引はどんな種類がありますか？"}

s-1. [提案する内容タイトル ex: "固定金額"]: [提案する内容 ex: "固定金額クーポンを提供します。金額を自由に設定できるようにします。"]
s-2. [提案する内容タイトル ex: "%割引"]: [提案する内容 ex: "%割引クーポンを提供します。割引率を自由に設定できるようにします。"]
s-3. [提案する内容タイトル ex: "送料無料"]: [提案する内容 ex: "送料無料クーポンを提供します。送料を無料にできるようにします。"]
{...他にもあれば項目を追加してください。}

```
## 実装質問テンプレート

```
<!-- 
ユーザーの手間を最小限にしつつ、実装に必要な情報を収集するための質問テンプレートです。無駄な質問はせず、本質的に重要な質問のみ行いなさい。エンティティ構造などの各項目について、不明点がなければ質問をしないようにしなさい。強引にすべての項目について質問をしないようにしなさい。
 -->

実装を作成するにあたって、以下の質問に回答してください。複数選択可能です。

## エンティティ構造について

<!-- 

テーブルの構造や、型定義について質問します。

 -->

### {質問のタイトル}
{質問の内容 ex: "クーポンのエンティティ設計は複数の案があります。どのような案を選択しますか？"}

e-a-1. [提案内容 ex: "各情報をに専用のカラムを作成する"]
{
    どのような提案なのかを簡単に説明
}

{
    この提案内容のメリット、デメリットを説明
    メリット: 
        - エンティティの構造がシンプルになる
    デメリット: 
        - ソースコード側で暗黙的な処理が必要で、テーブル構造からCouponの振る舞いの判断が難しくなる
}

\`\`\`
model Coupon {
  id String @id @default(uuid())
  name String
  discountType String
  discountAmount Number
  expirationDate Date
  totalUsage Number
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

\`\`\`

e-a-2. [提案内容 ex: "各情報を1つのカラムにまとめる"]
{
    どのような提案なのかを簡単に説明
}

{
    この提案内容のメリット、デメリットを説明
    メリット: 
        - エンティティの構造がシンプルになる
    デメリット: 
        - ソースコード側で暗黙的な処理が必要で、テーブル構造からCouponの振る舞いの判断が難しくなる
}

\`\`\`
model Coupon {
  id String @id @default(uuid())
  name String
  discountType String
  discountAmount Number
}
{...他にもあれば項目を追加してください。}

## アーキテクチャについて

<!-- 
command,query,flowの構造について提案します。これらの構造は要求をどのようにソースコードに落とし込むかを示します。いくつかのパターンを提案しなさい。

 -->

### アーキテクチャ構造について

a-a-1. アーキテクチャ1

{アーキテクチャ1の説明: ex: "クーポンの有効性検証、検証について一つのクエリと一つのコマンドで行います。"}
{
    このアーキテクチャのメリット、デメリットを説明してください。

    ex: 
    メリット: 
    - 追加するコマンドとクエリが少ない

    デメリット:
    - 各コマンドでのロジックが複雑になる
    - 各コマンド内での処理がコマンド名だけで分かりにくい
    - update-couponコマンドでnullableな引数を受け取る必要があり、コードの複雑性が高まる
}

| コマンド名 | コマンドの説明 | コマンドの引数 | コマンドの返り値、エラーの型 | 実装内容 | 
| --- | --- | --- | --- | --- |
| features/coupon/query/validate-coupon.ts | クーポンの有効性を検証する | couponId: string | boolean or CouponTotalUsageOverError | 新規実装:利用回数がシステム全体での利用回数を超えている場合にエラーを返す |
| features/coupon/command/update-coupon.ts | クーポンを更新する | couponId: string, totalUsage?: number, expirationDate?: Date | void | 新規実装:利用回数を更新する。有効期限も更新できるようにします。 |
| ... | ... | ... | ... | ... |

a-a-2. アーキテクチャ2
{アーキテクチャ1の説明: ex: "クーポンの有効性検証、検証について対応するクエリとコマンドを分けて行います。"}
{
    このアーキテクチャのメリット、デメリットを説明してください。

    ex: 
    メリット: 
    - 各コマンドでのロジックがコマンド名から分かりやすい
    - 各コマンド内のソースコード量が少なくなる
    - update-couponコマンドでnullableな引数を受け取る必要がなくなり、コードの複雑性が低くなる

    デメリット:
    - 追加するコマンドとクエリが多くなる
}

| クエリ名 | クエリの説明 | クエリの引数 | クエリの返り値、エラーの型 | 実装内容 | 
| --- | --- | --- | --- | --- |
| features/coupon/query/validate-total-usage-coupon.ts | クーポンの利用回数がシステム全体での利用回数を超えているかを検証する | couponId: string | boolean | 新規実装:利用回数がシステム全体での利用回数を超えているかどうかをbooleanで返す。超えていない場合もエラーを返さない |
| features/coupon/command/validate-expiration-date-coupon.ts | クーポンの有効期限が過ぎているかを検証する | couponId: string | boolean | 新規実装:有効期限が過ぎているかどうかをbooleanで返す。過ぎていない場合もエラーを返さない |
| features/coupon/command/update-total-usage-coupon.ts | クーポンの利用回数を更新する | couponId: string, totalUsage: number | void | 新規実装:システム全体で利用できる利用回数を更新する。 |
| features/coupon/command/update-expiration-date-coupon.ts | クーポンの有効期限を更新する | couponId: string, expirationDate: Date | void | 新規実装:クーポンの有効期限を更新する。 |

| ... | ... | ... | ... | ... |

{...合理的な範囲で様々なアーキテクチャ案を提案してください。}

## 技術詳細について

<!-- 

技術的詳細について質問します。どのようなORMの選定や、新たにインストールするライブラリ等について質問します。

 -->

### {質問のタイトル ex: "永続化手段について"}
{質問の内容 ex: "クーポンの保存にはデータの永続化が必要です。永続化手段としてどのようなものを選定しますか？"}

t-a-1. [提案する内容 ex: "データベース: Prisma"]
t-a-2. [提案する内容 ex: "データベース:TypeORM"]
t-a-3. [提案する内容 ex: "ブラウザストレージ:IndexedDB"]
t-a-4. [提案する内容 ex: "ファイルストレージ:LocalStorage"]
t-a-5. [提案する内容 ex: "メモリ:InMemory"]
{...他にもあれば項目を追加してください。}

### {質問のタイトル ex: ""}
{質問の内容 ex: "クーポンの保存にはデータの永続化が必要です。永続化手段としてどのようなものを選定しますか？"}

t-b-1. [提案する内容 ex: "データベース: Prisma"]
t-b-2. [提案する内容 ex: "データベース:TypeORM"]
t-b-3. [提案する内容 ex: "ブラウザストレージ:IndexedDB"]
t-b-4. [提案する内容 ex: "ファイルストレージ:LocalStorage"]
t-b-5. [提案する内容 ex: "メモリ:InMemory"]
{...他にもあれば項目を追加してください。}

```


## ユーザーからの要求
$ARGUMENTS